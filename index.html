<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Great Indian Wave Menu</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    /* small visual tweaks so nested pack cards look clear */
    .pack-subcard { min-height: 56px; display:flex; align-items:center; justify-content:center; text-align:center; padding:0.5rem; }
    .pack-section-title { font-size:0.95rem; font-weight:600; margin-top:0.5rem; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="text-center mb-4">Great Indian Wave Menu</h1>
    <div id="menu-container"></div>
    <div id="error" class="text-danger mt-3" style="display:none;"></div>
  </div>

  <footer class="text-center py-3 mt-4 border-top">
    Made by Anirudh Gupta
  </footer>

  <script>
    // register service worker once, safely
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(reg => console.log('Service worker registered:', reg.scope))
          .catch(err => console.warn('Service worker failed:', err));
      });
    }

    // helper to create a card element for simple menu items
    function createSimpleCard(name, price) {
      const col = document.createElement('div');
      col.className = 'col-md-4';
      col.innerHTML = `
        <div class="card shadow-sm h-100">
          <div class="card-body d-flex flex-column">
            <h5 class="card-title mb-2">${escapeHtml(name)}</h5>
            <div class="mt-auto"><p class="card-text mb-0">${escapeHtml(price)}</p></div>
          </div>
        </div>
      `;
      return col;
    }

    // escape minimal HTML to avoid accidental injection from JSON strings
    function escapeHtml(str) {
      if (str === undefined || str === null) return '';
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    // main loader
    (function loadMenu() {
      fetch('menu.json')
        .then(response => {
          if (!response.ok) throw new Error('Failed to load menu.json: ' + response.status + ' ' + response.statusText);
          return response.json();
        })
        .then(data => {
          console.log('menu.json loaded', data);
          const container = document.getElementById('menu-container');

          // iterate categories in the JSON order
          Object.keys(data).forEach(category => {
            const section = document.createElement('section');
            section.className = 'mb-4';

            const heading = document.createElement('h3');
            heading.className = 'mt-4';
            heading.textContent = category;
            section.appendChild(heading);

            const row = document.createElement('div');
            row.className = 'row g-3';
            section.appendChild(row);

            // data[category] should be an array (per your JSON). guard if not.
            const items = Array.isArray(data[category]) ? data[category] : [];
            items.forEach(item => {
              // If item has nested pack sections, treat as pack
              const isPack = item && (item.rice_selection || item.salad_and_accompaniments || item.desserts || item.beverages);

              if (!isPack) {
                // simple item (name + price)
                row.appendChild(createSimpleCard(item.name, item.price));
              } else {
                // pack: full-width card with inner grid for subsections
                const packCol = document.createElement('div');
                packCol.className = 'col-12';

                const packCard = document.createElement('div');
                packCard.className = 'card shadow-sm mb-3';

                let inner = `
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start flex-wrap">
                      <h5 class="card-title mb-1">${escapeHtml(item.name)}</h5>
                      <div class="text-muted">${escapeHtml(item.price)}</div>
                    </div>
                `;

                // define subsections with display titles that match your JSON keys
                const subsections = [
                  { key: 'rice_selection', title: 'Rice Selection' },
                  { key: 'salad_and_accompaniments', title: 'Salad & Accompaniments' },
                  { key: 'desserts', title: 'Desserts' },
                  { key: 'beverages', title: 'Beverages' }
                ];

                subsections.forEach(sec => {
                  const arr = item[sec.key];
                  if (Array.isArray(arr) && arr.length) {
                    inner += `<div class="pack-section-title">${escapeHtml(sec.title)}:</div><div class="row g-2">`;
                    arr.forEach(sub => {
                      inner += `
                        <div class="col-6 col-sm-4 col-md-3">
                          <div class="card pack-subcard border">
                            <div>${escapeHtml(sub.name)}<div class="small text-muted">${escapeHtml(sub.price)}</div></div>
                          </div>
                        </div>
                      `;
                    });
                    inner += `</div>`; // close inner row
                  }
                });

                inner += `</div>`; // close card-body
                packCard.innerHTML = inner;
                packCol.appendChild(packCard);
                row.appendChild(packCol);
              }
            });

            container.appendChild(section);
          });
        })
        .catch(err => {
          console.error(err);
          const errEl = document.getElementById('error');
          errEl.style.display = 'block';
          errEl.textContent = 'Error loading menu.json â€” check console for details. Common cause: opening file directly (use a local server).';
        });
    })();
  </script>
</body>
</html>
